<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>è¿”æ¸ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ v8</title>
<style>
    /* ãƒªã‚»ãƒƒãƒˆã¨åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
        margin: 0; padding: 20px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background-color: #f9fafb; color: #1f2937;
        padding-bottom: 80px;
    }
    h1, h2, p { margin: 0; }


/* ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ */
.card {
    background: white; border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    padding: 20px; margin-bottom: 20px;
}
.header {
    border-bottom: 4px solid #3b82f6;
    display: flex; flex-direction: column; gap: 12px;
}
.title-row { display: flex; align-items: center; gap: 12px; }
.icon-box {
    background: #dbeafe; color: #2563eb;
    padding: 8px; border-radius: 8px; display: flex;
}
.badge {
    background: #eff6ff; border: 1px solid #dbeafe;
    padding: 10px 16px; border-radius: 8px;
    display: flex; justify-content: space-between; align-items: center;
}
.badge-val { font-size: 1.25rem; font-weight: bold; color: #1f2937; }
.badge-err { color: #ef4444; font-weight: bold; font-size: 0.875rem; display: flex; align-items: center; gap: 4px; }

/* ä»Šæ—¥ã®æ®‹é«˜è¡¨ç¤º */
.today-balance {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white; padding: 20px; border-radius: 12px;
    margin-bottom: 20px;
}
.today-balance .date { font-size: 0.875rem; opacity: 0.9; margin-bottom: 8px; }
.today-balance .amount { font-size: 2rem; font-weight: bold; }
.today-balance .interest-info { font-size: 0.75rem; opacity: 0.8; margin-top: 8px; }

/* ãƒ•ã‚©ãƒ¼ãƒ  */
.form-group { margin-bottom: 16px; }
.form-group:last-child { margin-bottom: 0; }
label { display: block; font-size: 0.75rem; font-weight: 600; color: #4b5563; margin-bottom: 4px; }
.input-wrap { position: relative; }
.input-icon {
    position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
    color: #9ca3af; pointer-events: none;
}
input[type="number"], input[type="date"] {
    width: 100%; padding: 10px 12px 10px 36px;
    border: 1px solid #d1d5db; border-radius: 8px;
    font-size: 1rem; -webkit-appearance: none;
}
input[type="number"]:focus, input[type="date"]:focus { 
    outline: none; border-color: #3b82f6; ring: 2px solid #93c5fd; 
}

/* ç‰¹åˆ¥ãªå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ */
.highlight-input input {
    border-color: #93c5fd; color: #1e3a8a; font-weight: bold; font-size: 1.125rem;
}
.highlight-input .input-icon { color: #3b82f6; }

/* ãƒ†ãƒ¼ãƒ–ãƒ« */
.table-container {
    background: white; border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    overflow: hidden;
}
.table-header {
    background: #f3f4f6; padding: 12px;
    display: grid; grid-template-columns: 2fr 3fr 2.5fr 2.5fr 3fr;
    font-size: 0.75rem; font-weight: 600; color: #4b5563;
    border-bottom: 1px solid #e5e7eb;
}
.table-header > div { text-align: right; }
.table-header > div:first-child { text-align: center; }

.table-body { max-height: 400px; overflow-y: auto; }
.row {
    display: grid; grid-template-columns: 2fr 3fr 2.5fr 2.5fr 3fr;
    border-bottom: 1px solid #f3f4f6; align-items: center;
    font-size: 0.75rem;
    position: relative; /* å‰Šé™¤ãƒœã‚¿ãƒ³ã®é…ç½®ç”¨ */
}
.row.custom { background-color: #fefce8; }
.row.completed { background-color: #f0fdf4; opacity: 0.7; }
.row.planned { background-color: #fef3c7; }
.row > div { padding: 10px 6px; text-align: right; }
.row > div:first-child { text-align: center; color: #6b7280; font-weight: 500; font-size: 0.7rem; }

/* ãƒ†ãƒ¼ãƒ–ãƒ«å†…ã®å…¥åŠ› */
.row input[type="number"] {
    width: 100%; padding: 6px; text-align: right;
    border: 1px solid #e5e7eb; border-radius: 4px;
    font-size: 0.875rem; background: #f9fafb;
    padding-left: 6px;
}
.row.custom input { background: white; border-color: #fde047; }

/* ã‚°ãƒ©ãƒ• */
.chart-legend { 
    display: flex; 
    justify-content: center; 
    gap: 8px; 
    font-size: 0.65rem; 
    margin-top: 12px; 
    font-weight: 500;
    flex-wrap: wrap;
}
.legend-item { 
    display: flex; 
    align-items: center; 
    gap: 4px;
    white-space: nowrap;
}
.dot { width: 12px; height: 12px; border-radius: 3px; }
.dot-p { background: #3b82f6; }
.dot-i { background: #fb923c; }

.chart-labels {
    display: flex;
    justify-content: flex-start;
    margin-top: 8px;
    font-size: 0.6rem;
    color: #6b7280;
    padding: 0 4px;
    white-space: nowrap;
    overflow-x: auto;
    gap: 2px;
    -webkit-overflow-scrolling: touch;
}

.chart-labels::-webkit-scrollbar {
    height: 4px;
}

.chart-labels::-webkit-scrollbar-track {
    background: #f3f4f6;
    border-radius: 2px;
}

.chart-labels::-webkit-scrollbar-thumb {
    background: #d1d5db;
    border-radius: 2px;
}

.chart-labels span {
    flex-shrink: 0;
    flex: 1;
    text-align: center;
    min-width: fit-content;
}

/* ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ */
.text-blue { color: #2563eb; }
.text-orange { color: #f97316; }
.text-gray { color: #9ca3af; }
.text-green { color: #10b981; }
.w-icon { width: 20px; height: 20px; }
.reset-btn {
    background: none; border: 1px solid #fca5a5; color: #ef4444;
    border-radius: 4px; padding: 4px 8px; font-size: 0.75rem;
    cursor: pointer; margin-left: auto;
}

.info-box {
    background: #fef3c7; border-left: 4px solid #f59e0b;
    padding: 12px; border-radius: 4px; font-size: 0.875rem;
    margin-top: 12px;
}

.simulation-box {
    background: #f0fdf4; border: 2px solid #86efac;
    border-radius: 12px; padding: 16px;
}

.simulation-result {
    background: #dcfce7; border-left: 4px solid #22c55e;
    padding: 16px; border-radius: 8px; margin-top: 16px;
}

.impact-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #bbf7d0;
}

.impact-item:last-child {
    border-bottom: none;
}

.impact-label {
    font-size: 0.875rem;
    color: #166534;
}

.impact-value {
    font-size: 1.125rem;
    font-weight: bold;
    color: #15803d;
}

.impact-value.positive {
    color: #16a34a;
}

.btn-primary {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    width: 100%;
    box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
    transition: all 0.2s;
}

.btn-primary:active {
    transform: scale(0.98);
}

.btn-secondary {
    background: white;
    color: #6b7280;
    border: 1px solid #d1d5db;
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-secondary:active {
    background: #f9fafb;
}

.progress-container {
    background: white;
    border-radius: 12px;
    padding: 16px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.progress-label {
    font-size: 0.875rem;
    font-weight: 600;
    color: #4b5563;
}

.progress-percentage {
    font-size: 1.5rem;
    font-weight: bold;
    background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.progress-bar-wrapper {
    width: 100%;
    height: 24px;
    background: #e5e7eb;
    border-radius: 12px;
    overflow: hidden;
    position: relative;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
}

.progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 50%, #ec4899 100%);
    border-radius: 12px;
    transition: width 1s ease-out;
    position: relative;
    overflow: hidden;
}

.progress-bar-fill::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    bottom: 0;
    right: 0;
    background: linear-gradient(
        90deg,
        rgba(255, 255, 255, 0) 0%,
        rgba(255, 255, 255, 0.3) 50%,
        rgba(255, 255, 255, 0) 100%
    );
    animation: shimmer 2s infinite;
}

@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

.progress-details {
    display: flex;
    justify-content: space-between;
    margin-top: 8px;
    font-size: 0.75rem;
    color: #6b7280;
}

.verification-box {
    background: #dcfce7; border-left: 4px solid #22c55e;
    padding: 12px; border-radius: 4px; font-size: 0.875rem;
    margin-top: 12px;
}

.verification-box.error {
    background: #fee2e2; border-left: 4px solid #ef4444;
}


</style>
</head>
<body>

<!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->

<div class="card header">
    <div class="title-row">
        <div class="icon-box">
            <svg class="w-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        </div>
        <div>
            <h1 style="font-size: 1.25rem; font-weight: bold;">è¿”æ¸ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
            <p style="font-size: 0.75rem; color: #6b7280;">v8 å˜åˆ©æ—¥æ¯è¨ˆç®—</p>
        </div>
    </div>


<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
    <div class="badge">
        <span style="font-size: 0.75rem; color: #2563eb; font-weight: bold;">è¿”æ¸ˆå®Œäº†ã¾ã§</span>
        <span id="duration-display" class="badge-val">--</span>
    </div>
    <div class="badge" style="background: #fef3c7; border-color: #fde047;">
        <span style="font-size: 0.75rem; color: #92400e; font-weight: bold;">å®Œæ¸ˆäºˆå®š</span>
        <span id="completion-date-header" class="badge-val" style="color: #78350f; font-size: 0.95rem; white-space: nowrap;">--</span>
    </div>
</div>


</div>

<!-- ä»Šæ—¥ã®æ®‹é«˜ -->

<div class="today-balance">
    <div class="date" id="today-date">--</div>
    <div class="amount" id="today-balance">Â¥--</div>
    <div class="interest-info" id="daily-interest">--</div>
</div>

<!-- å®Œæ¸ˆç‡ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ -->

<div class="progress-container">
    <div class="progress-header">
        <span class="progress-label">ğŸ’ª å®Œæ¸ˆé€²æ—ç‡</span>
        <span class="progress-percentage" id="completion-percentage">0%</span>
    </div>
    <div class="progress-bar-wrapper">
        <div class="progress-bar-fill" id="progress-bar-fill" style="width: 0%"></div>
    </div>
    <div class="progress-details">
        <span>å…ƒé‡‘è¿”æ¸ˆæ¸ˆ: <strong id="principal-paid">Â¥0</strong></span>
        <span>æ®‹ã‚Šå…ƒé‡‘: <strong id="principal-remaining">Â¥0</strong></span>
    </div>
</div>

<!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->

<div class="card">
    <h2 style="font-size: 1rem; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid #f3f4f6; padding-bottom: 8px;">
        <svg class="w-icon text-blue" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
        å€Ÿå…¥æƒ…å ±
    </h2>


<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; padding: 12px; background: #f9fafb; border-radius: 8px;">
    <div>
        <p style="font-size: 0.75rem; color: #6b7280; margin-bottom: 4px;">åŸºæº–æ—¥</p>
        <p style="font-size: 1rem; font-weight: 600;">2025/11/06</p>
    </div>
    <div>
        <p style="font-size: 0.75rem; color: #6b7280; margin-bottom: 4px;">å€Ÿå…¥é‡‘é¡</p>
        <p style="font-size: 1rem; font-weight: 600;">Â¥1,086,102</p>
    </div>
    <div>
        <p style="font-size: 0.75rem; color: #6b7280; margin-bottom: 4px;">å¹´åˆ©</p>
        <p style="font-size: 1rem; font-weight: 600;">18.0%</p>
    </div>
    <div>
        <p style="font-size: 0.75rem; color: #6b7280; margin-bottom: 4px;">è¨ˆç®—æ–¹å¼</p>
        <p style="font-size: 1rem; font-weight: 600;">å˜åˆ©æ—¥å‰²</p>
    </div>
</div>

<div class="info-box">
    ğŸ’¡ <strong>å˜åˆ©æ—¥æ¯è¨ˆç®—:</strong> åˆ©æ¯ã¯å…ƒé‡‘Ã—0.18Ã—æ—¥æ•°Ã·365ã§æ¯æ—¥ç™ºç”Ÿã—ã¾ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’é–‹ããŸã³ã«ã€ä»Šæ—¥æ™‚ç‚¹ã§ã®æœ€æ–°æ®‹é«˜ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
</div>

<div style="display: flex; justify-content: space-between; margin-top: 16px; padding-top: 12px; border-top: 1px solid #f3f4f6;">
    <div>
        <p style="font-size: 0.75rem; color: #6b7280;">ç·æ”¯æ‰•äºˆå®šé¡</p>
        <p id="total-payment" style="font-size: 1.125rem; font-weight: bold;">Â¥0</p>
    </div>
    <div style="text-align: right;">
        <p style="font-size: 0.75rem; color: #6b7280;">ã†ã¡åˆ©æ¯</p>
        <p id="total-interest" style="font-size: 1.125rem; font-weight: bold; color: #f97316;">Â¥0</p>
    </div>
</div>


</div>

<!-- ã‚°ãƒ©ãƒ•ï¼ˆå®Ÿç¸¾+ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµ±åˆï¼‰ -->

<div class="card">
    <h2 style="font-size: 1rem; font-weight: 600; margin-bottom: 8px;">è¿”æ¸ˆæ¨ç§»</h2>
    <p style="font-size: 0.75rem; color: #6b7280; margin-bottom: 16px;">å®Ÿç¸¾ï¼ˆæ¿ƒè‰²ï¼‰ã¨æœˆå¹³å‡è¿”æ¸ˆé¡ã§ã®äºˆæ¸¬ï¼ˆæ·¡è‰²ï¼‰</p>


<div style="height: 200px; width: 100%;">
    <svg id="combined-chart" width="100%" height="100%" viewBox="0 0 100 100" preserveAspectRatio="none" style="overflow: visible;">
    </svg>
</div>
<div id="combined-labels" class="chart-labels"></div>
<div class="chart-legend">
    <div class="legend-item"><span class="dot dot-p"></span> å…ƒé‡‘ï¼ˆå®Ÿç¸¾ï¼‰</div>
    <div class="legend-item"><span class="dot dot-i"></span> åˆ©æ¯ï¼ˆå®Ÿç¸¾ï¼‰</div>
    <div class="legend-item"><span class="dot" style="background: #93c5fd;"></span> å…ƒé‡‘ï¼ˆäºˆæ¸¬ï¼‰</div>
    <div class="legend-item"><span class="dot" style="background: #fed7aa;"></span> åˆ©æ¯ï¼ˆäºˆæ¸¬ï¼‰</div>
</div>
<div style="margin-top: 12px; padding: 12px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #3b82f6;">
    <label style="font-size: 0.75rem; color: #1e40af; font-weight: 600; margin-bottom: 4px; display: block;">ğŸ“Š æœˆå¹³å‡è¿”æ¸ˆé¡</label>
    <div style="display: flex; gap: 8px; align-items: center;">
        <div style="position: relative; flex: 1;">
            <span style="position: absolute; left: 8px; top: 50%; transform: translateY(-50%); color: #1e3a8a; font-weight: 600;">Â¥</span>
            <input 
                type="number" 
                id="avg-payment-input" 
                style="width: 100%; padding: 8px 8px 8px 24px; border: 2px solid #3b82f6; border-radius: 6px; font-size: 1.125rem; font-weight: bold; color: #1e3a8a;"
                step="1000"
                onchange="updateAvgPayment()"
            >
        </div>
        <button 
            onclick="resetAvgPayment()" 
            style="padding: 8px 12px; background: white; border: 1px solid #3b82f6; color: #3b82f6; border-radius: 6px; font-size: 0.75rem; cursor: pointer; white-space: nowrap;"
        >
            è‡ªå‹•è¨ˆç®—
        </button>
    </div>
    <p style="font-size: 0.65rem; color: #1e40af; margin-top: 4px; opacity: 0.8;">â€» æ‰‹å‹•ã§å¤‰æ›´å¯èƒ½ã€‚ã€Œè‡ªå‹•è¨ˆç®—ã€ã§å®Ÿç¸¾å¹³å‡ã«æˆ»ã‚Šã¾ã™</p>
</div>


</div>

<!-- ãƒ†ãƒ¼ãƒ–ãƒ« -->

<div class="table-container">
    <div style="padding: 12px; background: #f9fafb; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e5e7eb;">
        <div>
            <h2 style="font-size: 0.875rem; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                <svg class="w-icon text-gray" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                è¿”æ¸ˆå®Ÿç¸¾
            </h2>
            <p style="font-size: 0.65rem; color: #9ca3af; margin-top: 4px;">â€» 1ã€œ5æ—¥ã®è¿”æ¸ˆã¯å‰æœˆåˆ†ã¨ã—ã¦é›†è¨ˆ</p>
        </div>
    </div>


<div class="table-header">
    <div>è¿”æ¸ˆæ—¥</div>
    <div style="border-left: 1px solid #e5e7eb;">è¿”æ¸ˆé¡</div>
    <div style="border-left: 1px solid #e5e7eb;">åˆ©æ¯</div>
    <div style="border-left: 1px solid #e5e7eb;">å…ƒé‡‘</div>
    <div style="border-left: 1px solid #e5e7eb;">æ®‹é«˜</div>
</div>

<div id="table-body" class="table-body">
</div>

<!-- è¿”æ¸ˆäºˆå®šè¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
<div style="padding: 16px; background: #f0fdf4; border-top: 2px solid #86efac;">
    <h3 style="font-size: 0.875rem; font-weight: 600; color: #166534; margin-bottom: 12px; display: flex; align-items: center; gap: 6px;">
        <svg style="width: 16px; height: 16px;" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M12 4v16m8-8H4"/>
        </svg>
        è¿”æ¸ˆäºˆå®šã‚’è¿½åŠ 
    </h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 8px; align-items: end;">
        <div>
            <label style="font-size: 0.7rem; color: #166534; font-weight: 600; display: block; margin-bottom: 4px;">è¿”æ¸ˆäºˆå®šæ—¥</label>
            <input type="date" id="new-payment-date" style="width: 100%; padding: 8px; border: 1px solid #86efac; border-radius: 6px; font-size: 0.875rem;">
        </div>
        <div>
            <label style="font-size: 0.7rem; color: #166534; font-weight: 600; display: block; margin-bottom: 4px;">è¿”æ¸ˆé‡‘é¡ (å††)</label>
            <input type="number" id="new-payment-amount" placeholder="100000" step="1000" style="width: 100%; padding: 8px; border: 1px solid #86efac; border-radius: 6px; font-size: 0.875rem;">
        </div>
        <button onclick="addPaymentPlan()" style="padding: 10px 16px; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; border: none; border-radius: 6px; font-size: 0.875rem; font-weight: 600; cursor: pointer; white-space: nowrap;">
            â• è¿½åŠ 
        </button>
    </div>
</div>


</div>

<script>
    // å®Ÿéš›ã®è¿”æ¸ˆè¨˜éŒ²ï¼ˆå¹´ã‚’ä¿®æ­£: 2024â†’2025ï¼‰
    const paymentHistory = [
        { date: '2025-11-06', amount: 10000 },
        { date: '2025-11-17', amount: 45000 },
        { date: '2025-11-27', amount: 15000 },
        { date: '2025-12-08', amount: 10000 },
        { date: '2025-12-24', amount: 115000 },
        { date: '2025-12-28', amount: 25000 },
        { date: '2025-12-29', amount: 15000 },
        { date: '2026-01-06', amount: 10000 },
        { date: '2026-01-23', amount: 45000 },
        { date: '2026-01-27', amount: 15000 },
        { date: '2026-02-02', amount: 134977 },
        { date: '2026-02-06', amount: 10000 }
    ];
    
    // æ¤œç®—ç”¨: 2026/2/14æ™‚ç‚¹ã®æ­£ã—ã„æ®‹é«˜
    const EXPECTED_BALANCE_2026_02_14 = 681840.00;

    // å›ºå®šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
    const INITIAL_LOAN = 1086101.84;
    const BASE_DATE = new Date('2025-11-06');
    const INTEREST_RATE = 18.0;

    // çŠ¶æ…‹ç®¡ç†
    const state = {
        loanAmount: INITIAL_LOAN,
        baseDate: BASE_DATE,
        interestRate: INTEREST_RATE,
        paymentHistory: paymentHistory,
        plannedPayments: [], // è¿”æ¸ˆäºˆå®šãƒªã‚¹ãƒˆ
        customAvgPayment: null, // ã‚«ã‚¹ã‚¿ãƒ å¹³å‡è¿”æ¸ˆé¡ï¼ˆnull = è‡ªå‹•è¨ˆç®—ï¼‰
        plan: [],
        summary: { total: 0, interest: 0, payments: 0 }
    };

    // è¦ç´ ã®å–å¾—
    const els = {
        duration: document.getElementById('duration-display'),
        completionDateHeader: document.getElementById('completion-date-header'),
        todayDate: document.getElementById('today-date'),
        todayBalance: document.getElementById('today-balance'),
        dailyInterest: document.getElementById('daily-interest'),
        completionPercentage: document.getElementById('completion-percentage'),
        progressBarFill: document.getElementById('progress-bar-fill'),
        principalPaid: document.getElementById('principal-paid'),
        principalRemaining: document.getElementById('principal-remaining'),
        totalPay: document.getElementById('total-payment'),
        totalInt: document.getElementById('total-interest'),
        avgPaymentInput: document.getElementById('avg-payment-input'),
        combinedChart: document.getElementById('combined-chart'),
        combinedLabels: document.getElementById('combined-labels'),
        tbody: document.getElementById('table-body')
    };

    // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•°ï¼ˆå°æ•°ç‚¹åˆ‡ã‚Šä¸Šã’ï¼‰
    const fmt = (n) => Math.ceil(n).toLocaleString();
    
    // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    const fmtDate = (date) => {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}/${m}/${d}`;
    };
    
    // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆçŸ­ç¸®ç‰ˆ: YY/MMï¼‰
    const fmtDateShort = (date) => {
        const y = String(date.getFullYear()).slice(-2); // ä¸‹2æ¡
        const m = date.getMonth() + 1;
        return `${y}/${m}`;
    };

    // æ—¥æ•°è¨ˆç®—
    const daysBetween = (date1, date2) => {
        const d1 = new Date(date1);
        const d2 = new Date(date2);
        d1.setHours(0, 0, 0, 0);
        d2.setHours(0, 0, 0, 0);
        const diff = d2 - d1;
        return Math.floor(diff / (1000 * 60 * 60 * 24));
    };

    // å…¨ã¦ã®è¿”æ¸ˆï¼ˆå®Ÿç¸¾+äºˆå®šï¼‰ã‚’å–å¾—
    const getAllPayments = () => {
        const allPayments = [
            ...state.paymentHistory.map(p => ({ ...p, isPlanned: false })),
            ...state.plannedPayments.map(p => ({ ...p, isPlanned: true }))
        ];
        return allPayments.sort((a, b) => new Date(a.date) - new Date(b.date));
    };

    // ä»Šæ—¥ã®æ®‹é«˜ã‚’è¨ˆç®—ï¼ˆå®Ÿéš›ã®è¿”æ¸ˆè¨˜éŒ²+äºˆå®šã«åŸºã¥ãï¼‰
    const calculateTodayBalance = () => {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const rate = state.interestRate / 100;
        let balance = state.loanAmount;
        
        // å…¨ã¦ã®è¿”æ¸ˆï¼ˆå®Ÿç¸¾+äºˆå®šï¼‰ã‚’å–å¾—
        const payments = getAllPayments();
        
        let lastDate = new Date(state.baseDate);
        lastDate.setHours(0, 0, 0, 0);
        
        // å„è¿”æ¸ˆã®å‡¦ç†
        for (const payment of payments) {
            const paymentDate = new Date(payment.date);
            paymentDate.setHours(0, 0, 0, 0);
            
            if (paymentDate > today) break;
            
            // lastDateã‹ã‚‰paymentDateã¾ã§ã®æ—¥æ•°
            const days = daysBetween(lastDate, paymentDate);
            
            // å˜åˆ©è¨ˆç®—: å…ƒé‡‘ Ã— 0.18 Ã— æ—¥æ•° Ã· 365
            const interest = balance * rate * days / 365;
            
            // è¿”æ¸ˆå‰æ®‹é«˜ = å‰å›æ®‹é«˜ + åˆ©æ¯
            const balanceBeforePayment = balance + interest;
            
            // è¿”æ¸ˆå¾Œæ®‹é«˜ = è¿”æ¸ˆå‰æ®‹é«˜ - è¿”æ¸ˆé¡
            balance = balanceBeforePayment - payment.amount;
            
            lastDate = new Date(paymentDate);
        }
        
        // æœ€å¾Œã®è¿”æ¸ˆæ—¥ï¼ˆã¾ãŸã¯åŸºæº–æ—¥ï¼‰ã‹ã‚‰ä»Šæ—¥ã¾ã§ã®æ—¥æ•°
        const daysFromLast = daysBetween(lastDate, today);
        const accruedInterest = balance * rate * daysFromLast / 365;
        
        return {
            balance: balance,
            daysAccrued: daysFromLast,
            interestAccrued: accruedInterest,
            totalBalance: balance + accruedInterest
        };
    };

    // è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆè¿”æ¸ˆè¨˜éŒ²+äºˆå®šã«åŸºã¥ãï¼‰
    function calculate() {
        const annualRate = state.interestRate / 100;
        let balance = state.loanAmount;
        let totalInt = 0;
        let totalPaid = 0;

        state.plan = [];

        // å…¨ã¦ã®è¿”æ¸ˆï¼ˆå®Ÿç¸¾+äºˆå®šï¼‰ã‚’å–å¾—
        const payments = getAllPayments();

        let lastDate = new Date(state.baseDate);
        lastDate.setHours(0, 0, 0, 0);

        payments.forEach((payment, index) => {
            const paymentDate = new Date(payment.date);
            paymentDate.setHours(0, 0, 0, 0);
            
            // å‰å›ã®æ—¥ä»˜ã‹ã‚‰ä»Šå›ã®è¿”æ¸ˆæ—¥ã¾ã§ã®æ—¥æ•°
            const days = daysBetween(lastDate, paymentDate);
            
            // å˜åˆ©è¨ˆç®—: å…ƒé‡‘ Ã— 0.18 Ã— æ—¥æ•° Ã· 365
            const interest = balance * annualRate * days / 365;
            
            // è¿”æ¸ˆå‰æ®‹é«˜
            const balanceBeforePayment = balance + interest;
            
            // è¿”æ¸ˆå¾Œæ®‹é«˜
            balance = balanceBeforePayment - payment.amount;
            
            // å®Ÿéš›ã«æ”¯æ‰•ã£ãŸåˆ©æ¯åˆ†ï¼ˆè¿”æ¸ˆé¡ã®ã†ã¡åˆ©æ¯ã«å……å½“ã•ã‚ŒãŸé¡ï¼‰
            const interestPaid = Math.min(interest, payment.amount);
            const principalPaid = payment.amount - interestPaid;
            
            totalInt += interestPaid;
            totalPaid += payment.amount;

            state.plan.push({
                index: index,
                date: new Date(paymentDate),
                payment: payment.amount,
                principal: principalPaid,
                interest: interestPaid,
                balance: balance,
                daysElapsed: days,
                isPlanned: payment.isPlanned
            });

            lastDate = new Date(paymentDate);
        });

        state.summary.total = totalPaid;
        state.summary.interest = totalInt;
        state.summary.payments = state.plan.length;

        render();
    }
    
    // å°†æ¥äºˆæ¸¬ã‚’è¨ˆç®—ï¼ˆæœˆå¹³å‡è¿”æ¸ˆé¡ã§è¿”æ¸ˆã‚’ç¶šã‘ãŸå ´åˆï¼‰
    function calculateForecast() {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        // å‰æœˆã®æœ€çµ‚æ—¥ã‚’å–å¾—
        const lastMonth = new Date(today.getFullYear(), today.getMonth(), 0);
        
        const monthlyData = {};
        
        // å®Ÿç¸¾ã®ã¿ã‚’é›†è¨ˆï¼ˆäºˆå®šã¯é™¤å¤–ï¼‰
        state.plan.filter(row => !row.isPlanned).forEach(row => {
            const date = new Date(row.date);
            const day = date.getDate();
            
            // 1-5æ—¥ã®å ´åˆã¯å‰æœˆã¨ã—ã¦æ‰±ã†
            let displayDate = new Date(date);
            if (day >= 1 && day <= 5) {
                displayDate.setMonth(displayDate.getMonth() - 1);
            }
            
            // å‰æœˆã¾ã§ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’é›†è¨ˆ
            if (displayDate <= lastMonth) {
                const monthKey = `${displayDate.getFullYear()}-${String(displayDate.getMonth() + 1).padStart(2, '0')}`;
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = 0;
                }
                monthlyData[monthKey] += row.payment;
            }
        });
        
        const monthlyPayments = Object.values(monthlyData);
        
        // è‡ªå‹•è¨ˆç®—ã®æœˆå¹³å‡
        const calculatedAvgPayment = monthlyPayments.length > 0
            ? monthlyPayments.reduce((sum, p) => sum + p, 0) / monthlyPayments.length
            : 0;
        
        // ã‚«ã‚¹ã‚¿ãƒ å€¤ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã°è‡ªå‹•è¨ˆç®—å€¤
        const avgMonthlyPayment = state.customAvgPayment !== null 
            ? state.customAvgPayment 
            : calculatedAvgPayment;
        
        // ç¾åœ¨ã®æ®‹é«˜ã‹ã‚‰é–‹å§‹
        const todayData = calculateTodayBalance();
        let balance = todayData.balance;
        
        // æœ€å¾Œã®è¿”æ¸ˆæ—¥ã‚’å–å¾—
        const lastPaymentDate = state.plan.length > 0 
            ? new Date(state.plan[state.plan.length - 1].date)
            : new Date(state.baseDate);
        
        // ä»Šæ—¥ã‹ã‚‰æœ€å¾Œã®è¿”æ¸ˆæ—¥ã¾ã§ã®åˆ©æ¯ã‚’åŠ ç®—
        const daysFromLastPayment = daysBetween(lastPaymentDate, today);
        const accruedInterest = balance * (state.interestRate / 100) * daysFromLastPayment / 365;
        balance += accruedInterest;
        
        const forecast = [];
        const annualRate = state.interestRate / 100;
        let currentDate = new Date(today);
        let monthCount = 0;
        const MAX_MONTHS = 120; // 10å¹´ä¸Šé™
        
        while (balance > 0 && monthCount < MAX_MONTHS) {
            // æ¬¡ã®æœˆã®1æ—¥
            currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1);
            
            // 1ãƒ¶æœˆåˆ†ã®åˆ©æ¯ï¼ˆæ¦‚ç®—ã¨ã—ã¦30æ—¥ï¼‰
            const interest = balance * annualRate * 30 / 365;
            
            let payment = avgMonthlyPayment;
            
            // å®Œæ¸ˆãƒã‚§ãƒƒã‚¯
            if (balance + interest <= payment) {
                payment = balance + interest;
            }
            
            const principal = payment - interest;
            balance -= principal;
            
            if (balance < 0) balance = 0;
            
            forecast.push({
                date: new Date(currentDate),
                payment: payment,
                principal: principal,
                interest: interest,
                balance: balance
            });
            
            monthCount++;
        }
        
        return {
            avgMonthlyPayment: avgMonthlyPayment,
            forecast: forecast,
            completionDate: forecast.length > 0 ? forecast[forecast.length - 1].date : null,
            remainingMonths: forecast.length
        };
    }

    // æç”»é–¢æ•°
    function render() {
        // ä»Šæ—¥ã®æ®‹é«˜è¨ˆç®—
        const todayData = calculateTodayBalance();
        const today = new Date();
        
        els.todayDate.textContent = `${fmtDate(today)} æ™‚ç‚¹ã®æ®‹é«˜`;
        els.todayBalance.textContent = `Â¥${fmt(todayData.totalBalance)}`;
        els.dailyInterest.textContent = `å…ƒé‡‘ Â¥${fmt(todayData.balance)} + æœªæ‰•åˆ©æ¯ Â¥${fmt(todayData.interestAccrued)} (${todayData.daysAccrued}æ—¥åˆ†)`;

        // å®Œæ¸ˆç‡ã®è¨ˆç®—
        const initialLoan = state.loanAmount;
        const currentPrincipal = todayData.balance;
        const principalPaid = initialLoan - currentPrincipal;
        const completionRate = (principalPaid / initialLoan) * 100;
        
        // å®Œæ¸ˆç‡ã®è¡¨ç¤ºï¼ˆå°æ•°ç‚¹ç¬¬2ä½ã¾ã§ï¼‰
        els.completionPercentage.textContent = `${completionRate.toFixed(2)}%`;
        els.progressBarFill.style.width = `${completionRate}%`;
        els.principalPaid.textContent = `Â¥${fmt(principalPaid)}`;
        els.principalRemaining.textContent = `Â¥${fmt(currentPrincipal)}`;

        // å°†æ¥äºˆæ¸¬ã‚’è¨ˆç®—
        const forecastData = calculateForecast();
        
        // æœˆå¹³å‡è¿”æ¸ˆé¡ã‚’å…¥åŠ›æ¬„ã«è¡¨ç¤º
        els.avgPaymentInput.value = Math.ceil(forecastData.avgMonthlyPayment);
        
        // å®Œæ¸ˆäºˆå®šæ—¥ã¨æœŸé–“ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ã«è¡¨ç¤ºï¼‰
        if (forecastData.completionDate) {
            els.completionDateHeader.textContent = fmtDate(forecastData.completionDate);
            
            const years = Math.floor(forecastData.remainingMonths / 12);
            const months = forecastData.remainingMonths % 12;
                
            els.duration.textContent = years > 0 
                ? `${years}å¹´${months}ãƒ¶æœˆ` 
                : `${months}ãƒ¶æœˆ`;
        } else {
            els.completionDateHeader.textContent = 'è¨ˆç®—ä¸èƒ½';
            els.duration.textContent = 'è¦å¢—é¡';
        }
        
        els.totalPay.textContent = `Â¥${fmt(state.summary.total)}`;
        els.totalInt.textContent = `Â¥${fmt(state.summary.interest)}`;

        renderCombinedChart(forecastData.forecast);
        renderTable();
    }

    // çµ±åˆã‚°ãƒ©ãƒ•æç”»ï¼ˆå®Ÿç¸¾+äºˆæ¸¬ï¼‰
    function renderCombinedChart(forecastData) {
        const actualData = state.plan;
        
        if (actualData.length === 0) {
            els.combinedChart.innerHTML = '<text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#9ca3af" font-size="5">ãƒ‡ãƒ¼ã‚¿ãªã—</text>';
            els.combinedLabels.innerHTML = '';
            return;
        }

        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const currentMonthKey = `${today.getFullYear()}/${String(today.getMonth() + 1).padStart(2, '0')}`;

        // å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ã‚’æœˆã”ã¨ã«é›†è¨ˆï¼ˆ1-5æ—¥ã¯å‰æœˆæ‰±ã„ï¼‰
        // è¿”æ¸ˆäºˆå®šã‚‚å®Ÿç¸¾ã¨ã—ã¦æ‰±ã†
        const actualMonthly = {};
        actualData.forEach(row => {
            const date = new Date(row.date);
            const day = date.getDate();
            
            // 1-5æ—¥ã®å ´åˆã¯å‰æœˆã¨ã—ã¦æ‰±ã†
            let displayDate = new Date(date);
            if (day >= 1 && day <= 5) {
                displayDate.setMonth(displayDate.getMonth() - 1);
            }
            
            const monthKey = `${displayDate.getFullYear()}/${String(displayDate.getMonth() + 1).padStart(2, '0')}`;
            const displayKey = fmtDateShort(displayDate);
            
            if (!actualMonthly[monthKey]) {
                actualMonthly[monthKey] = { 
                    payment: 0, 
                    interest: 0, 
                    principal: 0, 
                    isActual: true, 
                    displayMonth: displayKey,
                    isCurrentMonth: monthKey === currentMonthKey
                };
            }
            actualMonthly[monthKey].payment += row.payment;
            actualMonthly[monthKey].interest += row.interest;
            actualMonthly[monthKey].principal += row.principal;
        });

        // äºˆæ¸¬ãƒ‡ãƒ¼ã‚¿ã‚’æœˆã”ã¨ã«å¤‰æ›ï¼ˆè¿”æ¸ˆäºˆå®šãŒãªã„æœˆã®ã¿ï¼‰
        const forecastMonthly = {};
        if (forecastData && forecastData.length > 0) {
            forecastData.forEach(row => {
                const date = new Date(row.date);
                const monthKey = `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}`;
                const displayKey = fmtDateShort(date);
                
                // ãã®æœˆã«å®Ÿç¸¾ï¼ˆè¿”æ¸ˆäºˆå®šå«ã‚€ï¼‰ãŒãªã„å ´åˆã®ã¿äºˆæ¸¬ã‚’è¿½åŠ 
                if (!actualMonthly[monthKey]) {
                    forecastMonthly[monthKey] = {
                        payment: row.payment,
                        interest: row.interest,
                        principal: row.principal,
                        isActual: false,
                        displayMonth: displayKey,
                        isCurrentMonth: monthKey === currentMonthKey
                    };
                }
            });
        }

        // å…¨ãƒ‡ãƒ¼ã‚¿ã‚’çµåˆ
        const allMonths = [...Object.keys(actualMonthly), ...Object.keys(forecastMonthly)];
        const uniqueMonths = [...new Set(allMonths)].sort();
        
        // æœˆå¹³å‡è¿”æ¸ˆé¡ã‚’å–å¾—ï¼ˆå½“æœˆã®äºˆæ¸¬ãƒãƒ¼ç”¨ï¼‰
        const forecastDataObj = calculateForecast();
        const avgPayment = forecastDataObj.avgMonthlyPayment;
        
        const chartData = uniqueMonths.map(month => {
            const actual = actualMonthly[month];
            const forecast = forecastMonthly[month];
            const isCurrentMonth = month === currentMonthKey;
            
            if (actual && isCurrentMonth) {
                // å½“æœˆï¼šå®Ÿç¸¾ã‚ã‚Šã€äºˆæ¸¬ã‚‚è¿½åŠ 
                return { 
                    month, 
                    payment: actual.payment,
                    interest: actual.interest,
                    principal: actual.principal,
                    isActual: true,
                    isCurrentMonth: true,
                    avgPayment: avgPayment, // äºˆæ¸¬é¡
                    displayMonth: actual.displayMonth
                };
            } else if (actual) {
                // éå»æœˆï¼šå®Ÿç¸¾ã®ã¿
                return { 
                    month, 
                    payment: actual.payment,
                    interest: actual.interest,
                    principal: actual.principal,
                    isActual: true,
                    isCurrentMonth: false,
                    displayMonth: actual.displayMonth
                };
            } else if (forecast) {
                // æœªæ¥æœˆï¼šäºˆæ¸¬ã®ã¿
                return { 
                    month, 
                    payment: forecast.payment,
                    interest: forecast.interest,
                    principal: forecast.principal,
                    isActual: false,
                    isCurrentMonth: false,
                    displayMonth: forecast.displayMonth
                };
            }
        }).filter(Boolean);

        const maxPay = Math.max(...chartData.map(d => d.payment || 0)) * 1.1;
        if (maxPay === 0) return;

        let svgContent = '';
        // ã‚°ãƒªãƒƒãƒ‰ç·š
        [0, 0.5, 1].forEach(t => {
            const y = 100 - (t * 100);
            svgContent += `<line x1="0" y1="${y}" x2="100" y2="${y}" stroke="#e5e7eb" stroke-width="0.5" vector-effect="non-scaling-stroke" />`;
        });

        // ãƒãƒ¼
        const count = chartData.length;
        const gap = count > 40 ? 0 : 1;
        const barW = (100 / count) - gap;

        chartData.forEach((d, i) => {
            const x = (i * (100 / count)) + (gap / 2);
            
            if (d.isCurrentMonth && d.isActual && d.avgPayment && d.avgPayment > 0) {
                // å½“æœˆï¼šäºˆæ¸¬ãƒãƒ¼ï¼ˆè–„è‰²ãƒ»èƒŒæ™¯ï¼‰+ å®Ÿç¸¾éƒ¨åˆ†ï¼ˆæ¿ƒè‰²ãƒ»å‰æ™¯ï¼‰ã‚’é‡ã­ã‚‹
                
                // äºˆæ¸¬ãƒãƒ¼ã®é«˜ã•ã‚’è¨ˆç®—ï¼ˆå¹³å‡è¿”æ¸ˆé¡ã§ï¼‰
                const avgInterestEstimate = d.avgPayment * 0.1; // æ¦‚ç®—10%ã‚’åˆ©æ¯ã¨ã™ã‚‹
                const avgPrincipalEstimate = d.avgPayment - avgInterestEstimate;
                
                const avgPH = Math.max(0, (avgPrincipalEstimate / maxPay) * 100);
                const avgIH = (avgInterestEstimate / maxPay) * 100;
                
                // 1. ã¾ãšäºˆæ¸¬ãƒãƒ¼ï¼ˆè–„è‰²ãƒ»èƒŒæ™¯ï¼‰ã‚’æç”»
                svgContent += `<rect x="${x}%" y="${100 - (avgPH + avgIH)}%" width="${barW}%" height="${avgIH}%" fill="#fed7aa" />`;
                svgContent += `<rect x="${x}%" y="${100 - avgPH}%" width="${barW}%" height="${avgPH}%" fill="#93c5fd" />`;
                
                // 2. ãã®ä¸Šã«å®Ÿç¸¾éƒ¨åˆ†ï¼ˆæ¿ƒè‰²ãƒ»å‰æ™¯ï¼‰ã‚’é‡ã­ã‚‹
                const pH = Math.max(0, (d.principal / maxPay) * 100);
                const iH = (d.interest / maxPay) * 100;
                
                if (iH > 0) {
                    svgContent += `<rect x="${x}%" y="${100 - (pH + iH)}%" width="${barW}%" height="${iH}%" fill="#fb923c" />`;
                }
                if (pH > 0) {
                    svgContent += `<rect x="${x}%" y="${100 - pH}%" width="${barW}%" height="${pH}%" fill="#3b82f6" />`;
                }
            } else if (d.isActual) {
                // éå»æœˆã¾ãŸã¯æœªæ¥ã®è¿”æ¸ˆäºˆå®šï¼šå®Ÿç¸¾ï¼ˆæ¿ƒè‰²ï¼‰ã®ã¿
                const pH = Math.max(0, (d.principal / maxPay) * 100);
                const iH = (d.interest / maxPay) * 100;
                
                svgContent += `<rect x="${x}%" y="${100 - (pH + iH)}%" width="${barW}%" height="${iH}%" fill="#fb923c" />`;
                if (d.principal > 0) {
                    svgContent += `<rect x="${x}%" y="${100 - pH}%" width="${barW}%" height="${pH}%" fill="#3b82f6" />`;
                }
            } else {
                // æœªæ¥æœˆï¼šäºˆæ¸¬ï¼ˆè–„è‰²ï¼‰ã®ã¿
                const pH = Math.max(0, (d.principal / maxPay) * 100);
                const iH = (d.interest / maxPay) * 100;
                
                svgContent += `<rect x="${x}%" y="${100 - (pH + iH)}%" width="${barW}%" height="${iH}%" fill="#fed7aa" />`;
                if (d.principal > 0) {
                    svgContent += `<rect x="${x}%" y="${100 - pH}%" width="${barW}%" height="${pH}%" fill="#93c5fd" />`;
                }
            }
        });

        els.combinedChart.innerHTML = svgContent;
        
        // å¹´æœˆãƒ©ãƒ™ãƒ«ã‚’å…¨ã¦è¡¨ç¤º
        let labelsHtml = '';
        chartData.forEach(d => {
            labelsHtml += `<span>${d.displayMonth}</span>`;
        });
        els.combinedLabels.innerHTML = labelsHtml;
    }

    // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
    function renderTable() {
        const fragment = document.createDocumentFragment();
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        if (state.plan.length === 0) {
            els.tbody.innerHTML = '<div style="padding:20px; text-align:center; color:#9ca3af;">è¿”æ¸ˆè¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
            return;
        }

        // plannedPaymentsã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¿½è·¡
        let plannedIndex = 0;

        // å…¨ã¦ã®è¿”æ¸ˆã‚’è¡¨ç¤ºï¼ˆå®Ÿç¸¾+äºˆå®šï¼‰
        state.plan.forEach((row, index) => {
            const div = document.createElement('div');
            const isCompleted = row.date <= today;
            const isPlanned = row.isPlanned;
            
            // éå»ã®å®Ÿç¸¾ã¯è–„ç·‘ã€è¿”æ¸ˆäºˆå®šã¯é»„è‰²
            if (isCompleted && !isPlanned) {
                div.className = 'row completed';
            } else if (isPlanned) {
                div.className = 'row planned';
            } else {
                div.className = 'row';
            }

            // 5ã¤ã®ã‚»ãƒ«ã‚’ä½œæˆ
            const dateCell = document.createElement('div');
            dateCell.textContent = fmtDate(row.date);
            
            const paymentCell = document.createElement('div');
            paymentCell.style.cssText = 'border-left:1px solid #f3f4f6; font-weight: 600;';
            paymentCell.textContent = fmt(row.payment);
            
            const interestCell = document.createElement('div');
            interestCell.className = 'text-orange';
            interestCell.style.cssText = 'border-left:1px solid #f3f4f6;';
            interestCell.textContent = fmt(row.interest);
            
            const principalCell = document.createElement('div');
            principalCell.className = 'text-blue';
            principalCell.style.cssText = 'border-left:1px solid #f3f4f6;';
            principalCell.textContent = fmt(row.principal);
            
            const balanceCell = document.createElement('div');
            balanceCell.className = 'text-gray';
            balanceCell.style.cssText = 'border-left:1px solid #f3f4f6; position: relative; display: flex; align-items: center; justify-content: flex-end; gap: 8px;';
            
            // æ®‹é«˜ãƒ†ã‚­ã‚¹ãƒˆã‚’spanè¦ç´ ã§ä½œæˆ
            const balanceText = document.createElement('span');
            balanceText.textContent = fmt(row.balance);
            balanceCell.appendChild(balanceText);
            
            div.appendChild(dateCell);
            div.appendChild(paymentCell);
            div.appendChild(interestCell);
            div.appendChild(principalCell);
            div.appendChild(balanceCell);
            
            // å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ï¼ˆè¿”æ¸ˆäºˆå®šã®ã¿ï¼‰ - æ®‹é«˜ã‚»ãƒ«ã®ä¸­ã«é…ç½®
            if (isPlanned) {
                const currentPlannedIndex = plannedIndex;
                
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'å‰Šé™¤';
                deleteBtn.type = 'button';
                deleteBtn.style.cssText = 'background: #ef4444; color: white; border: none; padding: 4px 10px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; cursor: pointer; white-space: nowrap;';
                
                deleteBtn.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    if (confirm('ã“ã®è¿”æ¸ˆäºˆå®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                        state.plannedPayments.splice(currentPlannedIndex, 1);
                        calculate();
                    }
                };
                
                balanceCell.appendChild(deleteBtn);
                plannedIndex++;
            }
            
            fragment.appendChild(div);
        });
        
        els.tbody.innerHTML = '';
        els.tbody.appendChild(fragment);
    }

    // å¹³å‡è¿”æ¸ˆé¡ã‚’æ›´æ–°
    window.updateAvgPayment = function() {
        const value = Number(els.avgPaymentInput.value);
        if (isNaN(value) || value < 0) {
            alert('æ­£ã—ã„é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }
        
        state.customAvgPayment = value;
        render(); // ã‚°ãƒ©ãƒ•ã‚’å†æç”»
    };
    
    // å¹³å‡è¿”æ¸ˆé¡ã‚’è‡ªå‹•è¨ˆç®—ã«æˆ»ã™
    window.resetAvgPayment = function() {
        state.customAvgPayment = null;
        render(); // ã‚°ãƒ©ãƒ•ã‚’å†æç”»
    };
    
    // åˆæœŸè¨ˆç®—
    calculate();
    
    // è¿”æ¸ˆäºˆå®šã‚’è¿½åŠ 
    window.addPaymentPlan = function() {
        const dateInput = document.getElementById('new-payment-date');
        const amountInput = document.getElementById('new-payment-amount');
        
        const date = dateInput.value;
        const amount = Number(amountInput.value);
        
        if (!date) {
            alert('è¿”æ¸ˆäºˆå®šæ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }
        
        if (!amount || amount <= 0) {
            alert('æ­£ã—ã„è¿”æ¸ˆé‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }
        
        const planDate = new Date(date);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        if (planDate < today) {
            alert('æœªæ¥ã®æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }
        
        // è¿”æ¸ˆäºˆå®šã‚’è¿½åŠ 
        state.plannedPayments.push({
            date: date,
            amount: amount
        });
        
        // æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆ
        state.plannedPayments.sort((a, b) => new Date(a.date) - new Date(b.date));
        
        // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
        dateInput.value = '';
        amountInput.value = '';
        
        // å†è¨ˆç®—
        calculate();
    };
    
    // æ—¥ä»˜ãŒå¤‰ã‚ã£ãŸã‚‰è‡ªå‹•æ›´æ–°ï¼ˆ1åˆ†ã”ã¨ã«ãƒã‚§ãƒƒã‚¯ï¼‰
    setInterval(() => {
        const now = new Date();
        if (now.getHours() === 0 && now.getMinutes() === 0) {
            render();
        }
    }, 60000);
</script>

</body>
</html>
