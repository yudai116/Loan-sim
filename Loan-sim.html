<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ローン返済シミュレーター v5</title>
<style>
    /* リセットと基本スタイル */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
        margin: 0; padding: 20px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background-color: #f9fafb; color: #1f2937;
        padding-bottom: 80px; /* 下部の余白 */
    }
    h1, h2, p { margin: 0; }

    /* コンポーネント */
    .card {
        background: white; border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        padding: 20px; margin-bottom: 20px;
    }
    .header {
        border-bottom: 4px solid #3b82f6;
        display: flex; flex-direction: column; gap: 12px;
    }
    .title-row { display: flex; align-items: center; gap: 12px; }
    .icon-box {
        background: #dbeafe; color: #2563eb;
        padding: 8px; border-radius: 8px; display: flex;
    }
    .badge {
        background: #eff6ff; border: 1px solid #dbeafe;
        padding: 10px 16px; border-radius: 8px;
        display: flex; justify-content: space-between; align-items: center;
    }
    .badge-val { font-size: 1.25rem; font-weight: bold; color: #1f2937; }
    .badge-err { color: #ef4444; font-weight: bold; font-size: 0.875rem; display: flex; align-items: center; gap: 4px; }

    /* フォーム */
    .form-group { margin-bottom: 16px; }
    .form-group:last-child { margin-bottom: 0; }
    label { display: block; font-size: 0.75rem; font-weight: 600; color: #4b5563; margin-bottom: 4px; }
    .input-wrap { position: relative; }
    .input-icon {
        position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
        color: #9ca3af; pointer-events: none;
    }
    input[type="number"] {
        width: 100%; padding: 10px 12px 10px 36px;
        border: 1px solid #d1d5db; border-radius: 8px;
        font-size: 1rem; -webkit-appearance: none;
    }
    input[type="number"]:focus { outline: none; border-color: #3b82f6; ring: 2px solid #93c5fd; }
    
    /* 特別な入力フィールド */
    .highlight-input input {
        border-color: #93c5fd; color: #1e3a8a; font-weight: bold; font-size: 1.125rem;
    }
    .highlight-input .input-icon { color: #3b82f6; }

    /* テーブル */
    .table-container {
        background: white; border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    .table-header {
        background: #f3f4f6; padding: 12px;
        display: grid; grid-template-columns: 2fr 4fr 3fr 3fr;
        font-size: 0.75rem; font-weight: 600; color: #4b5563;
        border-bottom: 1px solid #e5e7eb;
    }
    .table-header > div { text-align: right; }
    .table-header > div:first-child { text-align: center; }
    .table-header > div:nth-child(2) { text-align: center; }

    .table-body { max-height: 400px; overflow-y: auto; }
    .row {
        display: grid; grid-template-columns: 2fr 4fr 3fr 3fr;
        border-bottom: 1px solid #f3f4f6; align-items: center;
        font-size: 0.75rem;
    }
    .row.custom { background-color: #fefce8; }
    .row > div { padding: 10px 8px; text-align: right; }
    .row > div:first-child { text-align: center; color: #6b7280; font-weight: 500; }
    
    /* テーブル内の入力 */
    .row input {
        width: 100%; padding: 6px; text-align: right;
        border: 1px solid #e5e7eb; border-radius: 4px;
        font-size: 0.875rem; background: #f9fafb;
    }
    .row.custom input { background: white; border-color: #fde047; }

    /* グラフ */
    .chart-legend { display: flex; justify-content: center; gap: 16px; font-size: 0.75rem; margin-top: 12px; font-weight: 500; }
    .legend-item { display: flex; align-items: center; gap: 6px; }
    .dot { width: 12px; height: 12px; border-radius: 3px; }
    .dot-p { background: #3b82f6; }
    .dot-i { background: #fb923c; }

    /* ユーティリティ */
    .text-blue { color: #2563eb; }
    .text-orange { color: #f97316; }
    .text-gray { color: #9ca3af; }
    .w-icon { width: 20px; height: 20px; }
    .reset-btn {
        background: none; border: 1px solid #fca5a5; color: #ef4444;
        border-radius: 4px; padding: 4px 8px; font-size: 0.75rem;
        cursor: pointer; margin-left: auto;
    }
</style>
</head>
<body>

<!-- ヘッダー -->
<div class="card header">
    <div class="title-row">
        <div class="icon-box">
            <svg class="w-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><path d="M14 2v6h6"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></svg>
        </div>
        <div>
            <h1 style="font-size: 1.25rem; font-weight: bold;">返済シミュレーター</h1>
            <p style="font-size: 0.75rem; color: #6b7280;">自由返済版 v5</p>
        </div>
    </div>
    <div class="badge">
        <span style="font-size: 0.75rem; color: #2563eb; font-weight: bold;">返済完了まで</span>
        <span id="duration-display" class="badge-val">--</span>
    </div>
</div>

<!-- 入力フォーム -->
<div class="card">
    <h2 style="font-size: 1rem; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid #f3f4f6; padding-bottom: 8px;">
        <svg class="w-icon text-blue" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
        基本条件
    </h2>

    <div class="form-group">
        <label>借入金額 (円)</label>
        <div class="input-wrap">
            <div class="input-icon">¥</div>
            <!-- inputイベントをchangeイベントに変更 -->
            <input type="number" id="loanAmount" value="1090000" step="10000">
        </div>
    </div>

    <div class="form-group">
        <label>年利 (%)</label>
        <div class="input-wrap">
            <div class="input-icon">%</div>
            <!-- inputイベントをchangeイベントに変更 -->
            <input type="number" id="interestRate" value="18.0" step="0.1">
        </div>
    </div>

    <div class="form-group highlight-input">
        <label class="text-blue">基本返済額 (円/月)</label>
        <div class="input-wrap">
            <div class="input-icon">¥</div>
            <!-- inputイベントをchangeイベントに変更 -->
            <input type="number" id="basePayment" value="70000" step="1000">
        </div>
        <div id="min-interest-msg" style="display: none; margin-top: 4px; font-size: 0.75rem; color: #ef4444;">
            ⚠️ 利息未満です (最低 <span id="min-val"></span>円)
        </div>
    </div>

    <div style="display: flex; justify-content: space-between; margin-top: 16px; padding-top: 12px; border-top: 1px solid #f3f4f6;">
        <div>
            <p style="font-size: 0.75rem; color: #6b7280;">総支払額</p>
            <p id="total-payment" style="font-size: 1.125rem; font-weight: bold;">¥0</p>
        </div>
        <div style="text-align: right;">
            <p style="font-size: 0.75rem; color: #6b7280;">うち利息</p>
            <p id="total-interest" style="font-size: 1.125rem; font-weight: bold; color: #f97316;">¥0</p>
        </div>
    </div>
</div>

<!-- グラフ -->
<div class="card">
    <h2 style="font-size: 1rem; font-weight: 600; margin-bottom: 16px;">返済推移</h2>
    <div style="height: 200px; width: 100%;">
        <svg id="chart" width="100%" height="100%" viewBox="0 0 100 100" preserveAspectRatio="none" style="overflow: visible;">
            <!-- JSで描画 -->
        </svg>
    </div>
    <div class="chart-legend">
        <div class="legend-item"><span class="dot dot-p"></span> 元金</div>
        <div class="legend-item"><span class="dot dot-i"></span> 利息</div>
    </div>
</div>

<!-- テーブル -->
<div class="table-container">
    <div style="padding: 12px; background: #f9fafb; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e5e7eb;">
        <h2 style="font-size: 0.875rem; font-weight: 600; display: flex; align-items: center; gap: 6px;">
            <svg class="w-icon text-gray" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
            月別プラン
        </h2>
        <button id="reset-btn" class="reset-btn" style="display: none;">リセット</button>
    </div>
    
    <div class="table-header">
        <div>月</div>
        <div style="border-left: 1px solid #e5e7eb;">返済設定</div>
        <div style="border-left: 1px solid #e5e7eb;">利息</div>
        <div style="border-left: 1px solid #e5e7eb;">残高</div>
    </div>

    <div id="table-body" class="table-body">
        <!-- JSで生成 -->
    </div>
</div>

<script>
    // 状態管理
    const state = {
        loanAmount: 1090000,
        interestRate: 18.0,
        basePayment: 70000,
        customPayments: {}, // { month: amount }
        plan: [],
        summary: { total: 0, interest: 0, months: 0, infinite: false }
    };

    // 要素の取得
    const els = {
        loan: document.getElementById('loanAmount'),
        rate: document.getElementById('interestRate'),
        base: document.getElementById('basePayment'),
        minMsg: document.getElementById('min-interest-msg'),
        minVal: document.getElementById('min-val'),
        duration: document.getElementById('duration-display'),
        totalPay: document.getElementById('total-payment'),
        totalInt: document.getElementById('total-interest'),
        chart: document.getElementById('chart'),
        tbody: document.getElementById('table-body'),
        resetBtn: document.getElementById('reset-btn')
    };

    // フォーマット関数
    const fmt = (n) => n.toLocaleString();

    // 計算ロジック
    function calculate() {
        // パラメータのバリデーションと数値変換
        const loan = Number(els.loan.value);
        const rate = Number(els.rate.value);
        const base = Number(els.base.value);

        if (isNaN(loan) || loan <= 0 || isNaN(rate) || rate < 0 || isNaN(base) || base <= 0) {
            // 不正な値の場合はリセット（またはエラー表示）
            state.plan = [];
            state.summary = { total: 0, interest: 0, months: 0, infinite: true };
            render();
            return;
        }

        // 状態を更新
        state.loanAmount = loan;
        state.interestRate = rate;
        state.basePayment = base;


        const r = state.interestRate / 100 / 12;
        let balance = state.loanAmount;
        let totalInt = 0;
        let month = 1;
        const MAX_MONTHS = 600; // 50年で打ち切り

        state.plan = [];
        state.summary.infinite = false;

        while (balance > 0 && month <= MAX_MONTHS) {
            const interest = Math.floor(balance * r);
            
            // カスタム設定があれば優先
            let payment = state.customPayments[month] !== undefined 
                ? state.customPayments[month] 
                : state.basePayment;

            // 完済時の調整
            if (balance + interest <= payment) {
                payment = balance + interest;
            }

            let principal = payment - interest;
            
            // 支払額が利息以下の場合は残高が増える（または減らない）
            // この場合、無限ループ（返済不能）と判断する
            if (principal <= 0 && balance > 0) {
                 // 利息が支払額を上回っている限り、永遠に終わらない
                 state.summary.infinite = true;
                 break; 
            }

            balance -= principal;
            if (balance < 0) balance = 0;
            totalInt += interest;

            state.plan.push({
                month,
                payment,
                principal,
                interest,
                balance
            });

            // 無限ループ判定（早期終了）
            if (month > 120 && balance >= state.loanAmount) {
                state.summary.infinite = true;
                break;
            }

            month++;
        }

        if (month > MAX_MONTHS) state.summary.infinite = true;

        state.summary.total = state.loanAmount + totalInt;
        state.summary.interest = totalInt;
        state.summary.months = state.plan.length;

        render();
    }

    // 描画関数
    function render() {
        // サマリー更新
        if (state.summary.infinite) {
            els.duration.innerHTML = `<span class="badge-err">⚠️ 返済不能</span>`;
        } else {
            const y = Math.floor(state.summary.months / 12);
            const m = state.summary.months % 12;
            // 期間が0ヶ月の場合は「即時完済」と表示
            els.duration.textContent = state.summary.months === 0 
                ? '即時完済' 
                : (y > 0 ? `${y}年 ${m}ヶ月` : `${m}ヶ月`);
        }
        els.totalPay.textContent = `¥${fmt(state.summary.total)}`;
        els.totalInt.textContent = `¥${fmt(state.summary.interest)}`;

        // 最低返済額チェック
        const minInt = Math.floor(state.loanAmount * (state.interestRate / 100 / 12));
        if (state.basePayment < minInt) {
            els.minMsg.style.display = 'block';
            els.minVal.textContent = fmt(minInt);
        } else {
            els.minMsg.style.display = 'none';
        }

        // リセットボタン表示制御
        els.resetBtn.style.display = Object.keys(state.customPayments).length > 0 ? 'block' : 'none';

        renderChart();
        renderTable();
    }

    // グラフ描画 (SVG)
    function renderChart() {
        const data = state.plan;
        if (data.length === 0 || state.summary.infinite) {
            els.chart.innerHTML = '<text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#9ca3af" font-size="5" font-family="sans-serif">計算結果なし / 返済不能</text>';
            return;
        }

        // データ間引き（描画負荷軽減）
        const limit = 60;
        const chartData = data.length > limit 
            ? data.filter((_, i) => i % Math.ceil(data.length / limit) === 0) 
            : data;

        const maxPay = Math.max(...chartData.map(d => d.payment)) * 1.1;
        if (maxPay === 0) return;

        let svgContent = '';
        // グリッド線
        [0, 0.5, 1].forEach(t => {
            const y = 100 - (t * 100);
            svgContent += `<line x1="0" y1="${y}" x2="100" y2="${y}" stroke="#e5e7eb" stroke-width="0.5" vector-effect="non-scaling-stroke" />`;
        });

        // バー
        const count = chartData.length;
        const gap = count > 40 ? 0 : (20 / count);
        const barW = (100 / count) - gap;

        chartData.forEach((d, i) => {
            const x = (i * (100 / count)) + (gap / 2);
            const pH = Math.max(0, (d.principal / maxPay) * 100); // 元金高
            const iH = (d.interest / maxPay) * 100; // 利息高
            
            // 利息（上）
            svgContent += `<rect x="${x}%" y="${100 - (pH + iH)}%" width="${barW}%" height="${iH}%" fill="#fb923c" />`;
            // 元金（下）- マイナスの場合は描画しない
            if (d.principal > 0) {
                svgContent += `<rect x="${x}%" y="${100 - pH}%" width="${barW}%" height="${pH}%" fill="#3b82f6" />`;
            }
        });

        els.chart.innerHTML = svgContent;
    }

    // テーブル描画
    function renderTable() {
        const fragment = document.createDocumentFragment();
        
        // 返済不能の場合はテーブルを空にする
        if (state.summary.infinite || state.plan.length === 0) {
            els.tbody.innerHTML = '<div style="padding:20px; text-align:center; color:#9ca3af;">返済計画を計算できませんでした。</div>';
            return;
        }


        state.plan.forEach(row => {
            const div = document.createElement('div');
            const isCustom = state.customPayments[row.month] !== undefined;
            div.className = `row ${isCustom ? 'custom' : ''}`;
            
            div.innerHTML = `
                <div>${row.month}</div>
                <div style="border-left:1px solid #f3f4f6; padding:4px;">
                    <input 
                        type="number" 
                        value="${row.payment}" 
                        data-month="${row.month}" 
                        onchange="updateCustomPayment(this)"
                        onblur="updateCustomPayment(this)"
                    >
                </div>
                <div class="text-orange" style="border-left:1px solid #f3f4f6;">${fmt(row.interest)}</div>
                <div class="text-gray" style="border-left:1px solid #f3f4f6;">${fmt(row.balance)}</div>
            `;
            fragment.appendChild(div);
        });
        
        els.tbody.innerHTML = '';
        els.tbody.appendChild(fragment);
    }

    // イベントハンドラ: カスタム支払い更新
    window.updateCustomPayment = function(input) {
        const month = parseInt(input.getAttribute('data-month'));
        const val = parseInt(input.value);
        
        if (isNaN(val) || val < 0) {
            // 不正な入力の場合、元の値に戻す (ここでは単純に計算しない)
            // もしくは、state.basePaymentに戻す処理を追加しても良い
            return; 
        }

        if (val === state.basePayment) {
            delete state.customPayments[month];
        } else {
            state.customPayments[month] = val;
        }
        calculate();
    };

    // イベントリスナー設定
    // inputイベントが不発の場合があるため、changeとblurを追加
    const setupListeners = (el) => {
        const handler = (e) => { calculate(); };
        el.addEventListener('change', handler); // 変更確定時
        el.addEventListener('blur', handler);   // フォーカスアウト時
        el.addEventListener('input', handler);  // 念のためinputも残す
    };

    setupListeners(els.loan);
    setupListeners(els.rate);
    setupListeners(els.base);

    els.resetBtn.addEventListener('click', () => {
        // alertの代わりにconfirmを使用（iOS WebKitでは動作する可能性あり）
        if(confirm('個別の返済額設定をすべてリセットしますか？')) {
            state.customPayments = {};
            calculate();
        }
    });

    // 初期実行
    document.addEventListener('DOMContentLoaded', calculate);
    window.addEventListener('load', calculate); // 念のためload時にも実行
    
</script>
</body>
</html>

